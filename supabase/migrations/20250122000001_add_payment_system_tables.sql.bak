-- ============================================
-- Payment System Tables - Complete Implementation
-- ============================================

-- 1. payment_webhooks - Log all webhook events from Asaas
CREATE TABLE IF NOT EXISTS payment_webhooks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_type TEXT NOT NULL,
  payment_id UUID REFERENCES payments(id) ON DELETE SET NULL,
  asaas_payment_id TEXT,
  raw_payload JSONB NOT NULL,
  processed BOOLEAN DEFAULT false,
  processed_at TIMESTAMPTZ,
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for webhook processing
CREATE INDEX IF NOT EXISTS idx_payment_webhooks_asaas_id 
  ON payment_webhooks(asaas_payment_id);
CREATE INDEX IF NOT EXISTS idx_payment_webhooks_processed 
  ON payment_webhooks(processed, created_at) 
  WHERE processed = false;

COMMENT ON TABLE payment_webhooks IS 'Log de eventos de webhook do Asaas para auditoria e reprocessamento';
COMMENT ON COLUMN payment_webhooks.event_type IS 'Tipo do evento: PAYMENT_CREATED, PAYMENT_CONFIRMED, PAYMENT_RECEIVED, PAYMENT_OVERDUE, etc.';
COMMENT ON COLUMN payment_webhooks.raw_payload IS 'Payload completo do webhook em JSON';

-- ============================================
-- 2. plan_history - Skip (already exists with different structure)
-- CREATE TABLE IF NOT EXISTS plan_history (...)

-- ============================================
-- 3. Add missing columns to payments if not exists
-- (installment columns were added in previous migration)

-- Add additional payment tracking columns
ALTER TABLE payments 
ADD COLUMN IF NOT EXISTS payment_date DATE,
ADD COLUMN IF NOT EXISTS confirmed_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS invoice_url TEXT,
ADD COLUMN IF NOT EXISTS bank_slip_url TEXT;

-- Update comments
COMMENT ON COLUMN payments.asaas_payment_id IS 'ID único do pagamento no Asaas';
COMMENT ON COLUMN payments.asaas_subscription_id IS 'ID da subscription no Asaas (para planos recorrentes)';
COMMENT ON COLUMN payments.payment_date IS 'Data em que o pagamento foi efetivamente recebido';
COMMENT ON COLUMN payments.confirmed_at IS 'Timestamp de confirmação do pagamento';
COMMENT ON COLUMN payments.invoice_url IS 'URL da nota fiscal/invoice do Asaas';
COMMENT ON COLUMN payments.bank_slip_url IS 'URL do boleto bancário (se aplicável)';

-- ============================================
-- 4. Add missing columns to subscriptions if not exists

ALTER TABLE subscriptions
ADD COLUMN IF NOT EXISTS current_price DECIMAL(10,2),
ADD COLUMN IF NOT EXISTS customer_id UUID REFERENCES clients(id);

-- Update column comments
COMMENT ON COLUMN subscriptions.asaas_subscription_id IS 'ID da subscription no Asaas (para recorrência automática)';
COMMENT ON COLUMN subscriptions.billing_period IS 'Período de cobrança: monthly, quarterly, semiannual, annual';
COMMENT ON COLUMN subscriptions.billing_cycle IS 'Ciclo da Asaas: MONTHLY, QUARTERLY, SEMIANNUALLY, YEARLY';
COMMENT ON COLUMN subscriptions.current_price IS 'Preço atual da assinatura (pode diferir do plano por descontos)';
COMMENT ON COLUMN subscriptions.customer_id IS 'Referência ao cliente na tabela clients';
COMMENT ON COLUMN subscriptions.next_billing_date IS 'Próxima data de cobrança automática';

-- ============================================
-- 5. Update clients table with additional fields

ALTER TABLE clients
ADD COLUMN IF NOT EXISTS clinic_id UUID REFERENCES clinic_settings(id),
ADD COLUMN IF NOT EXISTS mobile_phone TEXT,
ADD COLUMN IF NOT EXISTS address TEXT,
ADD COLUMN IF NOT EXISTS address_number TEXT,
ADD COLUMN IF NOT EXISTS complement TEXT,
ADD COLUMN IF NOT EXISTS province TEXT,
ADD COLUMN IF NOT EXISTS postal_code TEXT,
ADD COLUMN IF NOT EXISTS notes TEXT,
ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();

-- Index for clinic filtering
CREATE INDEX IF NOT EXISTS idx_clients_clinic_id 
  ON clients(clinic_id);

COMMENT ON COLUMN clients.asaas_customer_id IS 'ID único do cliente no Asaas';
COMMENT ON COLUMN clients.clinic_id IS 'Clínica à qual o cliente pertence (multi-tenant)';
COMMENT ON COLUMN clients.mobile_phone IS 'Telefone celular do cliente';
COMMENT ON COLUMN clients.notes IS 'Observações sobre o cliente';

-- ============================================
-- 6. Add products table enhancements for subscription plans

ALTER TABLE products
ADD COLUMN IF NOT EXISTS max_professionals INTEGER,
ADD COLUMN IF NOT EXISTS max_patients INTEGER,
ADD COLUMN IF NOT EXISTS billing_period_months INTEGER;

-- Map period to months
UPDATE products SET billing_period_months = 1 WHERE period = 1;
UPDATE products SET billing_period_months = 3 WHERE period = 3;
UPDATE products SET billing_period_months = 6 WHERE period = 6;
UPDATE products SET billing_period_months = 12 WHERE period = 12;

COMMENT ON COLUMN products.max_professionals IS 'Número máximo de profissionais permitidos no plano';
COMMENT ON COLUMN products.max_patients IS 'Número máximo de pacientes permitidos no plano';
COMMENT ON COLUMN products.billing_period_months IS 'Período de cobrança em meses (1, 3, 6, 12)';
COMMENT ON COLUMN products.features IS 'Lista de funcionalidades do plano em JSON';
COMMENT ON COLUMN products.popular IS 'Indica se é o plano mais popular (destaque na UI)';

-- ============================================
-- 7. Performance indexes

-- Subscriptions indexes
CREATE INDEX IF NOT EXISTS idx_subscriptions_status_billing 
  ON subscriptions(status, next_billing_date) 
  WHERE status = 'active';

CREATE INDEX IF NOT EXISTS idx_subscriptions_clinic_status 
  ON subscriptions(clinic_id, status);

CREATE INDEX IF NOT EXISTS idx_subscriptions_asaas_id 
  ON subscriptions(asaas_subscription_id) 
  WHERE asaas_subscription_id IS NOT NULL;

-- Payments indexes
CREATE INDEX IF NOT EXISTS idx_payments_subscription 
  ON payments(subscription_id, created_at DESC)
  WHERE subscription_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_payments_clinic_status 
  ON payments(clinic_id, status, due_date);

CREATE INDEX IF NOT EXISTS idx_payments_asaas_subscription 
  ON payments(asaas_subscription_id) 
  WHERE asaas_subscription_id IS NOT NULL;

-- ============================================
-- 8. RLS Policies (Row Level Security)

-- Enable RLS on new tables
ALTER TABLE payment_webhooks ENABLE ROW LEVEL SECURITY;
ALTER TABLE plan_history ENABLE ROW LEVEL SECURITY;

-- Webhooks: Only service role can access
CREATE POLICY "Service role full access on payment_webhooks"
  ON payment_webhooks
  FOR ALL
  USING (auth.jwt() ->> 'role' = 'service_role');

-- Plan history: Users can view their clinic's history
CREATE POLICY "Users can view their clinic plan history"
  ON plan_history
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM subscriptions s
      INNER JOIN profiles p ON p.clinic_id = s.clinic_id
      WHERE s.id = plan_history.subscription_id
      AND p.id = auth.uid()
    )
  );

-- Plan history: Only admins can manage
CREATE POLICY "Admins can manage plan history"
  ON plan_history
  FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM profiles p
      WHERE p.id = auth.uid()
      AND p.role IN ('admin', 'super')
    )
  );

-- ============================================
-- 9. Triggers for updated_at

-- Update clients.updated_at automatically
CREATE OR REPLACE FUNCTION update_clients_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_clients_timestamp
  BEFORE UPDATE ON clients
  FOR EACH ROW
  EXECUTE FUNCTION update_clients_updated_at();

-- ============================================
-- 10. Helper Views

-- Active subscriptions with plan details
CREATE OR REPLACE VIEW active_subscriptions_view AS
SELECT 
  s.id,
  s.clinic_id,
  s.status,
  s.start_date,
  s.end_date,
  s.next_billing_date,
  s.current_price,
  s.billing_period,
  s.billing_cycle,
  s.asaas_subscription_id,
  p.name AS plan_name,
  p.features AS plan_features,
  c.name AS customer_name,
  c.email AS customer_email,
  c.asaas_customer_id
FROM subscriptions s
LEFT JOIN products p ON s.plan_id = p.id
LEFT JOIN clients c ON s.customer_id = c.id
WHERE s.status = 'active';

COMMENT ON VIEW active_subscriptions_view IS 'Visualização completa de assinaturas ativas com detalhes do plano e cliente';

-- ============================================
-- Success message
DO $$ 
BEGIN 
  RAISE NOTICE 'Payment system tables created successfully!';
  RAISE NOTICE 'Tables: payment_webhooks, plan_history';
  RAISE NOTICE 'Enhanced: payments, subscriptions, clients, products';
  RAISE NOTICE 'Created: Indexes, RLS policies, triggers, and views';
END $$;
